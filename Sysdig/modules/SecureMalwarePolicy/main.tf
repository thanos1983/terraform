resource "sysdig_secure_malware_policy" "secure_malware_policy" {
  name                  = var.name
  description           = var.description
  severity              = var.severity
  enabled               = var.enabled
  runbook               = var.runbook
  scope                 = var.scope
  notification_channels = var.notification_channels

  dynamic "actions" {
    for_each = var.actions_block[*]
    content {
      prevent_malware = actions.value.prevent_malware
      container       = actions.value.container
      dynamic "capture" {
        for_each = actions.value.capture_block[*]
        content {
          seconds_before_event = capture.value.seconds_before_event
          seconds_after_event  = capture.value.seconds_after_event
          name                 = capture.value.name
          filter               = capture.value.filter
          bucket_name          = capture.value.bucket_name
          folder               = capture.value.folder
        }
      }
    }
  }

  dynamic "rule" {
    for_each = var.rule_block[*]
    content {
      description        = rule.value.description
      use_managed_hashes = rule.value.use_managed_hashes
      dynamic "additional_hashes" {
        for_each = rule.value.additional_hashes_block[*]
        content {
          hash = additional_hashes.value.hash
        }
      }
      dynamic "ignore_hashes" {
        for_each = rule.value.ignore_hashes_block[*]
        content {
          hash = ignore_hashes.value.hash
        }
      }
    }
  }
}